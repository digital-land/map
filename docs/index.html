<!DOCTYPE html>
<html lang="en" class="govuk-template ">
  <head>
    <meta charset="utf-8">
    <title>National map of planning data | Digital Land</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <meta name="theme-color" content="#0b0c0c"> 
    
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    
	<link rel="manifest" href="/site.webmanifest">
<link rel="shortcut icon" sizes="48x48" href="/images/favicon.ico" type="image/x-icon">
<link rel="shortcut icon" sizes="32x32" href="/images/favicon-32x32.png" type="image/png">
<link rel="shortcut icon" sizes="16x16" href="/images/favicon-16x16.png" type="image/png">
<link rel="apple-touch-icon" href="/images/apple-touch-icon.png">


    
	<meta name="digital-land:template" content="dlf-base--full-width.html"><!-- should make this optional, no need to load if not showing a map -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
crossorigin="" />

<!-- Make sure you put this AFTER Leaflet's CSS -->
<script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
	integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
	crossorigin=""></script>

<!-- assets needed for fullscreen maps -->
<script src='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/Leaflet.fullscreen.min.js'></script>
<link href='https://api.mapbox.com/mapbox.js/plugins/leaflet-fullscreen/v1.0.1/leaflet.fullscreen.css' rel='stylesheet' />

<!-- script needed for recentring map -->
<script src="https://digital-land.github.io/javascripts/Leaflet.recentre.js"></script>

<script src="https://digital-land.github.io/javascripts/dl-maps.js"></script>
	
	<link href="https://digital-land.github.io/stylesheets/dl-frontend.css" rel="stylesheet" />
	<link href="https://digital-land.github.io/stylesheets/vendor/govuk-accessible-autocomplete.min.css" rel="stylesheet" media="all" />
	
<script src="./leaflet.permalink.min.js"></script>

    
    
    <meta property="og:image" content="/images/govuk-opengraph-image.png">
  </head>
  <body class="govuk-template__body ">
    <script>document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');</script>
    

    
      <a href="#main-content" class="govuk-skip-link">Skip to main content</a>
    

    
<!-- Cookie banner partial version 1.0.1 -->
<div id="global-cookie-message" class="govuk-clearfix global-cookie-message" data-module="cookie-banner" role="region" aria-label="cookie banner" data-nosnippet="">

  <div id="cookie-banner" class="govuk-width-container">
    <div class="govuk-grid-row">
      <div class="govuk-grid-column-two-thirds">
        <div class="cookie-banner__message govuk-!-margin-top-6">
          <h2 class="govuk-heading-m">Tell us whether you accept cookies</h2>
          <p class="govuk-body">We use <a class="govuk-link" href="/cookies">cookies to collect information</a> about how you use the Digital Land website to make the website work as well as possible.</p>
        </div>
        <div class="cooke-banner__buttons govuk-grid-row">
          <div class="govuk-grid-column-one-half">
            <button class="govuk-button" onclick="acceptCookies();showCookieConfirmation();">Accept all cookies</button>
          </div>
          <div class="govuk-grid-column-one-half">
            <a class="govuk-button" href="/cookies">Set cookie preferences</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="cookie-confirmation" class="govuk-width-container govuk-!-padding-top-6" tabindex="-1" style="display: none;">
    <p class="cookie-banner__confirmation-message govuk-body">You’ve accepted all cookies. You can <a class="govuk-link" href="/cookies">change your cookie settings</a> at any time.</p>
    <button class="cookie-banner__hide-button govuk-button govuk-button--secondary" onclick="document.getElementById('cookie-confirmation').style.display='none';">Hide</button>
  </div>

</div>


<header role="banner" id="global-header" class="govuk-header  with-proposition dl-header dl-header--full" data-module="govuk-header">
  <div class="govuk-header__container dl-full-width-container">
    <div class="header-proposition">
      <div class="govuk-header__content">
        <a href="https://digital-land.github.io/" class="govuk-header__link govuk-header__link--service-name">
        Digital Land
        </a>
        <button type="button" class="govuk-header__menu-button govuk-js-header-toggle" aria-controls="navigation" aria-label="Show or hide Top Level Navigation">Menu</button>
        <nav>
          <ul id="navigation" class="govuk-header__navigation" aria-label="Top Level Navigation">
            
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/about">Team</a>
            </li>
            
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/project/">Projects</a>
            </li>
            
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/weeknote/">Weeknotes</a>
            </li>
            
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/blog-post/">Blog</a>
            </li>
            
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/guidance/">Guidance</a>
            </li>
            
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/dataset/">Datasets</a>
            </li>
            
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/organisation/">Organisations</a>
            </li>
            
            <li class="govuk-header__navigation-item">
              <a class="govuk-header__link" href="/map/">Map</a>
            </li>
            
          </ul>
        </nav>
        </div>
    </div>
  </div>
</header>



    
<div class="dl-full-width-container ">
    
    
<div class="govuk-phase-banner">
  <p class="govuk-phase-banner__content"><strong class="govuk-tag govuk-phase-banner__content__tag ">
  prototype
</strong><span class="govuk-phase-banner__text">
      This is a prototype. Please provide feedback to the Digital Land team.
    </span>
  </p>
</div>
    
    
    <main class="govuk-main-wrapper " id="main-content" role="main">
    
<div class="govuk-grid-row">
	<div class="govuk-grid-column-full">
  	<h1 class="govuk-heading-xl">National map of planning data</h1>
    </div>
</div>

<p id="aria-label-national-map" class="govuk-body-l">National map of the planning data collected and collated by Digital Land.</p>

<div class="dl-map__wrapper">
  <div id="mapid" style="height: 700px;" aria-labelledby="aria-label-national-map"></div>
  <div class="dl-map__side-panel">
    <div class="dl-map__side-panel__section">
      <h3 class="govuk-heading-s govuk-!-margin-bottom-0">Data layers</h3>
    </div>
    <div class="dl-map__side-panel__section">
      <ul class="govuk-list govuk-!-margin-bottom-0" data-module="layer-controls">
        
        <li class="govuk-!-margin-bottom-2" data-layer-control="local-authority-district">
          <div class="govuk-checkboxes__item">
            <input class="govuk-checkboxes__input" id="local-authority-district" name="local-authority-district" type="checkbox" value="local-authority-district" checked=&#39;checked&#39;>
            <label class="govuk-label govuk-checkboxes__label" for="local-authority-district">
              Local authority districts
            </label>
          </div>
        </li>
        
        <li class="govuk-!-margin-bottom-2" data-layer-control="parish">
          <div class="govuk-checkboxes__item">
            <input class="govuk-checkboxes__input" id="parish" name="parish" type="checkbox" value="parish" >
            <label class="govuk-label govuk-checkboxes__label" for="parish">
              Parishes
            </label>
          </div>
        </li>
        
        <li class="govuk-!-margin-bottom-2" data-layer-control="conservation-area">
          <div class="govuk-checkboxes__item">
            <input class="govuk-checkboxes__input" id="conservation-area" name="conservation-area" type="checkbox" value="conservation-area" >
            <label class="govuk-label govuk-checkboxes__label" for="conservation-area">
              Conservation areas
            </label>
          </div>
        </li>
        
        <li class="govuk-!-margin-bottom-2" data-layer-control="brownfield-land">
          <div class="govuk-checkboxes__item">
            <input class="govuk-checkboxes__input" id="brownfield-land" name="brownfield-land" type="checkbox" value="brownfield-land" >
            <label class="govuk-label govuk-checkboxes__label" for="brownfield-land">
              Brownfield land
            </label>
          </div>
        </li>
        
        <li class="govuk-!-margin-bottom-2" data-layer-control="heritage-coast">
          <div class="govuk-checkboxes__item">
            <input class="govuk-checkboxes__input" id="heritage-coast" name="heritage-coast" type="checkbox" value="heritage-coast" >
            <label class="govuk-label govuk-checkboxes__label" for="heritage-coast">
              Heritage coast
            </label>
          </div>
        </li>
        
        <li class="govuk-!-margin-bottom-2" data-layer-control="area-of-outstanding-natural-beauty">
          <div class="govuk-checkboxes__item">
            <input class="govuk-checkboxes__input" id="area-of-outstanding-natural-beauty" name="area-of-outstanding-natural-beauty" type="checkbox" value="area-of-outstanding-natural-beauty" >
            <label class="govuk-label govuk-checkboxes__label" for="area-of-outstanding-natural-beauty">
              Areas of outstanding natural beauty
            </label>
          </div>
        </li>
        
        <li class="govuk-!-margin-bottom-2" data-layer-control="ancient-woodland">
          <div class="govuk-checkboxes__item">
            <input class="govuk-checkboxes__input" id="ancient-woodland" name="ancient-woodland" type="checkbox" value="ancient-woodland" >
            <label class="govuk-label govuk-checkboxes__label" for="ancient-woodland">
              Ancient woodland
            </label>
          </div>
        </li>
        
      </ul>
    </div>
  </div>
</div>

    </main>
</div>


    
	
  	







<footer class="govuk-footer " role="contentinfo"
        >
  <div class="govuk-width-container dl-full-width-container">
    
    <div class="govuk-footer__meta">
      <div class="govuk-footer__meta-item govuk-footer__meta-item--grow">
        
          <h2 class="govuk-visually-hidden">Support links</h2>
              <ul class="govuk-footer__inline-list">
                
                  <li class="govuk-footer__inline-list-item">
                    <a class="govuk-footer__link" href="/cookies">
                      Cookies
                    </a>
                  </li>
                
                  <li class="govuk-footer__inline-list-item">
                    <a class="govuk-footer__link" href="/accessibility-statement">
                      Accessibility statement
                    </a>
                  </li>
                
                  <li class="govuk-footer__inline-list-item">
                    <a class="govuk-footer__link" href="/design-system">
                      Design system
                    </a>
                  </li>
                
              </ul>
            
          
          
            <div class="govuk-footer__meta-custom">
              The <a class="govuk-footer__link" href="https://github.com/digital-land/digital-land/">software</a> and <a class="govuk-footer__link" href="https://github.com/digital-land/digital-land/">data</a> used to build these pages is <a class="govuk-footer__link" href="https://github.com/digital-land/digital-land/blob/master/LICENSE">open source</a>.
            </div>
          
        
        <svg
          role="presentation"
          focusable="false"
          class="govuk-footer__licence-logo"
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 483.2 195.7"
          height="17"
          width="41"
        >
          <path
            fill="currentColor"
            d="M421.5 142.8V.1l-50.7 32.3v161.1h112.4v-50.7zm-122.3-9.6A47.12 47.12 0 0 1 221 97.8c0-26 21.1-47.1 47.1-47.1 16.7 0 31.4 8.7 39.7 21.8l42.7-27.2A97.63 97.63 0 0 0 268.1 0c-36.5 0-68.3 20.1-85.1 49.7A98 98 0 0 0 97.8 0C43.9 0 0 43.9 0 97.8s43.9 97.8 97.8 97.8c36.5 0 68.3-20.1 85.1-49.7a97.76 97.76 0 0 0 149.6 25.4l19.4 22.2h3v-87.8h-80l24.3 27.5zM97.8 145c-26 0-47.1-21.1-47.1-47.1s21.1-47.1 47.1-47.1 47.2 21 47.2 47S123.8 145 97.8 145"
          />
        </svg>
        <span class="govuk-footer__licence-description">
          All content is available under the
          <a
            class="govuk-footer__link"
            href="https://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
            rel="license"
          >Open Government Licence v3.0</a>, except where otherwise stated
        </span>
      </div>
      <div class="govuk-footer__meta-item">
        <a
          class="govuk-footer__link govuk-footer__copyright-logo"
          href="https://www.nationalarchives.gov.uk/information-management/re-using-public-sector-information/uk-government-licensing-framework/crown-copyright/"
        >© Crown copyright</a>
      </div>
    </div>
  </div>
</footer>


    
<script src="https://digital-land.github.io/javascripts/dl-cookies.js"></script>
	<script async src='https://www.google-analytics.com/analytics.js'></script>
	<!-- end google analytics -->
	

	<script src="https://digital-land.github.io/javascripts/govuk/govuk-frontend.min.js"></script>
	<script>
		// initiate all GOVUK components
		window.GOVUKFrontend.initAll();
	</script>

	
	
	<script src="https://digital-land.github.io/javascripts/dl-frontend.js"></script>
	<script>
		// adds any necessary polyfills
		window.DLFrontend.polyfill();
	</script>
	


<script src="./layer-controls.js"></script>
<script>
  // callback used when layer control is clicked
  function toggleLayer(map, datasetName, add) {
    const layer = layerMap[datasetName]
    if (add) {
      console.log("Debug: ", layer, datasetName)
      map.addLayer(layer)

      /* Not sure this is efficient
          What to limit the number of fetch requests. If layer toggled off then on
          with no move of the map there is no need to fetch all the features again */

      if (map._fetchSinceControlAction) {
        // if something has changed since layer last shown then trigger fetch all
        // can further improve by fetching only reenable layer
        fetchAll()
        map._fetchSinceControlAction = false
      }
      if (layer.getLayers().length === 0) {
        // if contains no layers then maybe no fetch has been done before
        fetchAll()
      }
    } else {
      map.removeLayer(layer)
    }
  }

  var mappos = L.Permalink.getMapLocation(6, [53.865, -5.101]);
  var theMap = L.map('mapid', {
    center: mappos.center,
    zoom: mappos.zoom
  });
  L.Permalink.setup(theMap);

  const $controlsList = document.querySelector('[data-module="layer-controls"]')
  const layerControlsComponent = new LayerControls($controlsList, theMap).init({
    toggleControlCallback: toggleLayer
  })

  var baseUrl = "https://datasette-demo.digital-land.info/view_model"
  var dlBaseUrl = "http://digital-land.github.io"

  var pageSize = 100

  // add the OpenStreetMap tiles
  L.tileLayer('https://tiles.wmflabs.org/bw-mapnik/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; <a href="https://openstreetmap.org/copyright">OpenStreetMap contributors</a>'
  }).addTo(theMap);

  let controller

  function abortAll() {
    controller.abort()
  }

  function fetchFeatures(progress, url, geoJsonLayer, signal, type_) {
    return new Promise((resolve, reject) => fetch(url, { signal })
      .then(response => {
          if (response.status !== 200)  {
            throw `${response.status}: ${response.statusText}`;
          }
          response.json().then(data => { 
            geoJsonLayer.addData(data)

            if(data.length >= pageSize) {
              progress && progress(geoJsonLayer, type_);
              lastItem = data[data.length - 1]
              let nextUrl = url
              nextUrl.searchParams.set("after", lastItem.id)
              fetchFeatures(progress, nextUrl, geoJsonLayer, signal, type_).then(resolve).catch(reject)
            } else {
              resolve(geoJsonLayer);
            }
          }).catch(reject);
      }).catch(reject));
    }

    function progressCallback(geoJsonLayer, type_) {
            console.debug(`${geoJsonLayer.getLayers().length} features fetched for ${type_}`);
    }

    function buildUrl(bounds, zoomLevel, type=false, after_rowid=0) {
      var query = "bounded_geography_simplified_paged"
      if (zoomLevel > 11) {query = "bounded_geography_full_paged"}
      if (type) {query = `${query}_by_type`}
      if (type == "brownfield-land") {query = "bounded_geography_brownfield_land"}

      url = new URL(`${baseUrl}/${query}.json?_json=geojson&_shape=arrayfirst&bbox_minx=${bounds._southWest.lng}&bbox_maxx=${bounds._northEast.lng}&bbox_miny=${bounds._southWest.lat}&bbox_maxy=${bounds._northEast.lat}&after=${after_rowid}`)

      if (type) url.searchParams.set("type", type)

      return url
    }

    var geoJsonLayerOptions = {
      style: function(feature) {
        switch (feature.properties.type) {
          case 'local-authority-district': return {color: "#EE7800", weight: 2};
          case 'parish': return {color: "#5694ca", weight: 2};
          case 'conservation-area': return {color: "#78AA00", weight: 2};
          case 'brownfield-land': return {color: "#0078ff", weight: 2};
          case 'heritage-coast': return {color: "#912b88", weight: 2};
          case 'area-of-outstanding-natural-beauty': return {color: "#d53880", weight: 2};
          case 'ancient-woodland': return {color: "#00703c", weight: 2};
        }
      },
      onEachFeature: onEachFeature,
    }

    var geojsonLocalAuthorityDistrict = L.geoJSON(false, geoJsonLayerOptions).addTo(theMap)
    var geojsonConservationArea = L.geoJSON(false, geoJsonLayerOptions).addTo(theMap)
    var geojsonHeritageCoast = L.geoJSON(false, geoJsonLayerOptions).addTo(theMap)
    var geojsonAreaOfOutstandingNaturalBeauty = L.geoJSON(false, geoJsonLayerOptions).addTo(theMap)
    var geojsonAncientWoodland = L.geoJSON(false, geoJsonLayerOptions).addTo(theMap)
    var geojsonParish = L.geoJSON(false, geoJsonLayerOptions).addTo(theMap)
    //var geojsonBrownfieldLand = L.geoJSON(false, geoJsonLayerOptions).addTo(theMap)
    var geojsonBrownfieldLand = DLMaps.brownfieldSites.geojsonToLayer(false, geoJsonLayerOptions).addTo(theMap)
  
    var layerMap = {
      "local-authority-district": geojsonLocalAuthorityDistrict,
      "conservation-area": geojsonConservationArea,
      "brownfield-land": geojsonBrownfieldLand,
      "heritage-coast": geojsonHeritageCoast,
      "area-of-outstanding-natural-beauty": geojsonAreaOfOutstandingNaturalBeauty,
      "ancient-woodland": geojsonAncientWoodland,
      "parish": geojsonParish
    }

    function onEachFeature(feature, layer) {
      if (feature.properties) {
        layer.bindPopup(`
          <h3>${feature.properties.name}</h3>
          ${feature.properties.type}<br>
          <a href=${dlBaseUrl}${feature.properties.slug}>${feature.properties.slug}</a>
        `);
      }
    }

    function fetchAll(bounds=theMap.getBounds()) {
      if (controller) {
        console.log("controller.abort()")
        controller && controller.abort()
      }
      for (const [key, value] of Object.entries(layerMap)) {
        value.clearLayers()
      }
      controller = new AbortController();
      layerControlsComponent.enabledLayers().forEach(layer => {
        let type_ = layer.dataset.layerControl
        let zoom = theMap.getZoom()

        // limit layers with a lot of features to only appear at set zoom level
        if (type_ == "brownfield-land" && zoom < 13) {return}
        if (type_ == "ancient-woodland" && zoom < 11) {return}
        if (type_ == "parish" && zoom < 10) {return}

        console.log("fetching", type_)
        fetchFeatures(progressCallback, buildUrl(bounds, zoom, type_), layerMap[type_], controller.signal, type_).then(function (geoJsonLayer) {
          console.log("fetch complete", type_)
        }).catch(() => {
          console.log("caught error from fetch", type_)
          console.error
        })
      })
    }

    theMap.on('moveend', function(event){
      var bounds = event.target.getBounds()
      fetchAll(bounds)
      theMap._fetchSinceControlAction = true
    });

    fetchAll()

</script>

  </body>
</html>